trigger:
- main
- refs/tags/v*

jobs:
- job: apps
  pool:
    vmImage: windows-2022

  steps:
  - checkout: self
    fetchDepth: 0

  - task: UseGitVersion@5
    inputs:
      versionSpec: '5.11.x'

  - task: DotNetCoreCLI@2
    displayName: dotnet restore
    inputs:
      command: 'restore'
      projects: '**/*.csproj'
      feedsToUse: 'config'
      nugetConfigPath: 'nuget.config'

  - task: DotNetCoreCLI@2
    displayName: publish services (Linux)
    inputs:
      command: 'publish'
      publishWebProjects: false
      projects: 'src/Eryph.GuestServices.Service/*.csproj'
      arguments: '--configuration $(buildConfiguration) --runtime linux-x64 --output $(Build.ArtifactStagingDirectory)/egs_build/linux_amd64'
      zipAfterPublish: false
  
  - task: ArchiveFiles@2
    displayName: pack zero build
    inputs:
      rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/egs_build/linux_amd64'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/egs/egs_$(Build.BuildNumber)_linux_amd64.zip'

  - task: DotNetCoreCLI@2
    displayName: publish services (Windows)
    inputs:
      command: 'publish'
      publishWebProjects: false
      projects: 'src/Eryph.GuestServices.Service/*.csproj'
      arguments: '--configuration $(buildConfiguration) --runtime win-x64 --output $(Build.ArtifactStagingDirectory)/egs_build/windows_amd64'
      zipAfterPublish: false

  - task: ArchiveFiles@2
    displayName: pack zero build
    inputs:
      rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/egs_build/windows_amd64'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/egs/egs_$(Build.BuildNumber)_windows_amd64.zip'

  # TODO sign executables

  - task: PublishBuildArtifacts@1
    displayName: upload zero artifact
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/egs'
      ArtifactName: 'egs'
